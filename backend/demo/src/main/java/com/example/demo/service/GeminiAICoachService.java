package com.example.demo.service;

import com.example.demo.DTO.AIResponseDTO;
import com.example.demo.DTO.ChatMessageDTO;
import com.example.demo.DTO.ChatRequestDTO;
import com.example.demo.Repo.ChatMessageRepository;
import com.example.demo.entity.ChatMessage;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.*;
import java.util.stream.Collectors;
import java.util.Calendar;

@Service // ƒê√¢y l√† nh√£n cho Spring Boot bi·∫øt ƒë√¢y l√† m·ªôt "d·ªãch v·ª•" - nh∆∞ m·ªôt nh√¢n vi√™n chuy√™n l√†m vi·ªác g√¨ ƒë√≥
public class GeminiAICoachService {
    // Nh∆∞ ch√¨a kh√≥a ƒë·ªÉ m·ªü c·ª≠a nh√† Google AI - c·∫ßn c√≥ ƒë·ªÉ ƒë∆∞·ª£c ph√©p s·ª≠ d·ª•ng d·ªãch v·ª• AI
    @Value("${google.ai.api.key}")
    private String apiKey;
    @Value("${google.ai.model:gemini-1.5-flash}")  //  Using free Flash model for unlimited usage
    private String model;

    // ƒê·ªÉ l∆∞u/l·∫•y tin nh·∫Øn t·ª´ database
    @Autowired
    private ChatMessageRepository chatMessageRepository;
    
    // C√¥ng c·ª• ƒë·ªÉ g·ª≠i HTTP request ƒë·∫øn API b√™n ngo√†i
    // Nh∆∞ m·ªôt ng∆∞·ªùi ƒë∆∞a th∆∞, chuy√™n g·ª≠i tin nh·∫Øn qua internet
    private final RestTemplate restTemplate = new RestTemplate();
    
    //  T·∫†O PH·∫¢N H·ªíI AI
    public AIResponseDTO generateResponse(ChatRequestDTO request) {
        try {
            // L∆∞u tin nh·∫Øn user
            saveChatMessage(request.getUserId(), request.getMessage(), "USER");
            
            // T·∫°o context cho coach
            String prompt = buildCoachPrompt(request.getMessage(), request.getUserId());
            
            // G·ªçi Gemini API
            String aiResponse = callGeminiAPIWithRetry(prompt);
            
            // L∆∞u ph·∫£n h·ªìi AI
            saveChatMessage(request.getUserId(), aiResponse, "AI");
            
            return new AIResponseDTO(aiResponse);
        } catch (Exception e) {
            System.err.println("Error generating AI response: " + e.getMessage());
            // N·∫øu AI l·ªói, d√πng c√¢u tr·∫£ l·ªùi d·ª± ph√≤ng th√¥ng minh
            String fallbackResponse = getSmartFallbackResponse(request.getMessage());
            saveChatMessage(request.getUserId(), fallbackResponse, "AI");
            return new AIResponseDTO(fallbackResponse, "fallback");
        }
    }

    // G·ªåI API GEMINI
    private String callGeminiAPI(String prompt) {
        //  Gi·ªëng nh∆∞ b·∫°n t√¨m s·ªë ƒëi·ªán tho·∫°i c·ªßa chuy√™n gia t∆∞ v·∫•n cai thu·ªëc l√° trong danh b·∫°. 
        //  apiKey l√† nh∆∞ m·ªôt "m√£ kh√°ch h√†ng VIP" ƒë·ªÉ Google bi·∫øt b·∫°n c√≥ quy·ªÅn g·ªçi cho AI n√†y.
        String url = String.format("https://generativelanguage.googleapis.com/v1beta/models/%s:generateContent?key=%s", 
                                   model, apiKey);
        //  Th√¥ng tin k√®m theo y√™u c·∫ßu (ki·ªÉu d·ªØ li·ªáu JSON)
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        
        Map<String, Object> requestBody = Map.of(
            "contents", List.of(
                Map.of("parts", List.of(
                    Map.of("text", prompt) // // C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng
                ))
            ),  "generationConfig", Map.of(
                "temperature", 0.4,  //  ƒêi·ªÅu ch·ªânh ƒë·ªô s√°ng t·∫°o (0.4 = kh√° ·ªïn ƒë·ªãnh)
                "topK", 30,          // Ki·ªÉm so√°t c√°ch AI ch·ªçn t·ª´
                "topP", 0.8,         // Gi·ªõi h·∫°n ƒë·ªô d√†i ph·∫£n h·ªìi
                "maxOutputTokens", 400,  // Gi·ªõi h·∫°n ƒë·ªô d√†i ph·∫£n h·ªìi
                "candidateCount", 1,     // S·ªë ph·∫£n h·ªìi ƒë∆∞·ª£c t·∫°o
                "stopSequences", List.of("---", "###", "User:", "Q:") // D·ª´ng khi g·∫∑p c√°c chu·ªói n√†y
            ),
            "safetySettings", List.of( // B·ªô l·ªçc an to√†n, ch·ªâ ch·∫∑n n·ªôi dung r·∫•t c√≥ h·∫°i, cho ph√©p m·ª©c ƒë·ªô nh·∫π
                Map.of("category", "HARM_CATEGORY_HARASSMENT", "threshold", "BLOCK_ONLY_HIGH"), // qu·∫•y r·ªëi
                Map.of("category", "HARM_CATEGORY_HATE_SPEECH", "threshold", "BLOCK_ONLY_HIGH"), // L·ªçc l·ªùi n√≥i th√π ƒë·ªãch
                Map.of("category", "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold", "BLOCK_ONLY_HIGH"), // n·ªôi dung khi√™u d√¢m
                Map.of("category", "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold", "BLOCK_ONLY_HIGH") // n·ªôi dung nguy hi·ªÉm
            )
        );
        
        // G·ª≠i y√™u c·∫ßu POST ƒë·∫øn API
        // Gi·ªëng nh∆∞ b·∫°n ƒë√≥ng g√≥i c√¢u h·ªèi v√† g·ª≠i ƒë·∫øn Google AI
        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(requestBody, headers);
          try {
            // ƒë√≥ng g√≥i g√≥i tin ho√†n ch·ªânh (n·ªôi dung + header)
            // restTemplate.postForEntity() = g·ª≠i g√≥i tin ƒë·∫øn Google AI
            // response = nh·∫≠n ph·∫£n h·ªìi t·ª´ Google
            ResponseEntity<Map> response = restTemplate.postForEntity(url, entity, Map.class);
              if (response.getBody() != null) {
                Map<String, Object> responseBody = response.getBody();
                
                // Ki·ªÉm tra c√≥ ph·∫£n h·ªìi kh√¥ng
                if (responseBody.containsKey("error")) {
                    // L·∫•y n·ªôi dung ph·∫£n h·ªìi
                    Map errorObj = (Map) responseBody.get("error");
                    String errorMsg = "Gemini API Error: " + errorObj.get("message");
                    System.err.println(errorMsg);
                    throw new RuntimeException(errorMsg);
                }
                // danh s√°ch c√°c ph·∫£n h·ªìi c√≥ th·ªÉ t·ª´ AI
                List<Map> candidates = (List<Map>) responseBody.get("candidates");
                // Th∆∞·ªùng ch·ªâ c√≥ 1 ph·∫£n h·ªìi (v√¨ candidateCount = 1)
                // candidates.get(0) = l·∫•y ph·∫£n h·ªìi ƒë·∫ßu ti√™n
                if (candidates != null && !candidates.isEmpty()) {
                    Map candidate = candidates.get(0);
                    
                    //  Ki·ªÉm tra xem n·ªôi dung c√≥ b·ªã "ki·ªÉm duy·ªát" kh√¥ng.
                    if (candidate.containsKey("finishReason")) {
                        // L√Ω do AI d·ª´ng tr·∫£ l·ªùi
                        String finishReason = (String) candidate.get("finishReason");
                        System.out.println("Finish reason: " + finishReason);
                        // "SAFETY": AI ch·∫∑n v√¨ n·ªôi dung kh√¥ng an to√†n (nh∆∞ h·ªèi v·ªÅ t·ª± t·ª≠, b·∫°o l·ª±c...)
                        // "RECITATION": AI ch·∫∑n v√¨ ƒëang l·∫∑p l·∫°i n·ªôi dung s·∫µn c√≥ (nh∆∞ sao ch√©p trang web)
                        if ("SAFETY".equals(finishReason)) {
                            return "T√¥i hi·ªÉu b·∫°n ƒëang c·∫ßn h·ªó tr·ª£, nh∆∞ng h√£y th·ª≠ di·ªÖn ƒë·∫°t kh√°c m·ªôt ch√∫t ƒë·ªÉ t√¥i c√≥ th·ªÉ gi√∫p b·∫°n t·ªët h∆°n. üòä";
                        } else if ("RECITATION".equals(finishReason)) {
                            return "H√£y th·ª≠ h·ªèi theo c√°ch kh√°c, t√¥i s·∫Ω c·ªë g·∫Øng ƒë∆∞a ra l·ªùi khuy√™n ph√π h·ª£p cho b·∫°n! üí°";
                        }
                    }
                    //  L·∫•y N·ªôi Dung Ph·∫£n H·ªìi
                    Map content = (Map) candidate.get("content");
                    if (content != null) {
                        List<Map> parts = (List<Map>) content.get("parts");
                        
                        if (parts != null && !parts.isEmpty()) {
                            String aiText = (String) parts.get(0).get("text");
                            if (aiText != null && !aiText.trim().isEmpty()) {
                                System.out.println("‚úÖ AI response generated successfully");
                                return aiText.trim();
                            }
                        }
                    }
                }
                
                // Log the response structure for debugging  
                System.err.println("‚ö†Ô∏è Unexpected response structure. Candidates: " + 
                    (candidates != null ? candidates.size() : "null"));
            } else {
                System.err.println("‚ùå Empty response body from Gemini API");
            }
        } catch (Exception e) {
            System.err.println("Gemini API call failed: " + e.getMessage());
            e.printStackTrace();
            throw new RuntimeException("Gemini API call failed: " + e.getMessage());
        }
        
        throw new RuntimeException("No valid response from Gemini API");
    }
    
    private String callGeminiAPIWithRetry(String prompt) {
        //  M√¨nh s·∫Ω ch·ªâ th·ª≠ g·ªçi t·ªëi ƒëa 3 l·∫ßn
        int maxRetries = 3;
        // Gi·ªØa c√°c l·∫ßn g·ªçi, m√¨nh s·∫Ω ƒë·ª£i 1 gi√¢y, v√† tƒÉng d·∫ßn th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn g·ªçi
        int retryDelay = 1000; // 1 second
        
        // M√¨nh s·∫Ω b·∫Øt ƒë·∫ßu g·ªçi, ghi nh·ªõ ƒë√¢y l√† l·∫ßn th·ª≠ th·ª© m·∫•y
        for (int attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                System.out.println("Gemini API attempt " + attempt + "/" + maxRetries);
                // Nh·∫•n n√∫t g·ªçi cho b√°c sƒ© AI, g·ª≠i c√¢u h·ªèi c·ªßa b·ªánh nh√¢n
                return callGeminiAPI(prompt);
            } catch (Exception e) {
                System.err.println("Attempt " + attempt + " failed: " + e.getMessage());
                
                // "N·∫øu ƒë√¢y l√† l·∫ßn th·ª≠ cu·ªëi c√πng r·ªìi (l·∫ßn th·ª© 3)"
                // "ƒê√†nh ch·ªãu thua, b√°o l·ªói l√™n cho h·ªá th·ªëng bi·∫øt ch·∫Øc ch·∫Øn kh√¥ng g·ªçi ƒë∆∞·ª£c"
                if (attempt == maxRetries) {
                    throw e; // Throw after final attempt
                }
                
                try {
                    Thread.sleep(retryDelay * attempt); // ƒê·ª£i m·ªôt l√∫c tr∆∞·ªõc khi g·ªçi l·∫°i, Ki·ªÉu nh∆∞: "B√°c sƒ© b·∫≠n, ƒë·ª£i l√¢u h∆°n m·ªôt ch√∫t r·ªìi g·ªçi l·∫°i"
                } catch (InterruptedException ie) {
                    // N·∫øu B·ªã Gi√°n ƒêo·∫°n Khi ƒêang ƒê·ª£i
                    Thread.currentThread().interrupt(); // N·∫øu c√≥ ai ƒë√≥ l√†m phi·ªÅn khi ƒëang ƒë·ª£i ƒë·ªÉ g·ªçi l·∫°i
                    throw new RuntimeException("Retry interrupted", ie); // B√°o l·ªói: 'Xin l·ªói, t√¥i b·ªã gi√°n ƒëo·∫°n khi ƒëang c·ªë g·∫Øng g·ªçi l·∫°i'
                }
            }
        }
        
        throw new RuntimeException("All retry attempts failed");
        // D√≤ng n√†y g·∫ßn nh∆∞ kh√¥ng bao gi·ªù ch·∫°y ƒë·∫øn (v√¨ loop ƒë√£ x·ª≠ l√Ω m·ªçi tr∆∞·ªùng h·ª£p)
        // "B√°o l·ªói cu·ªëi c√πng: ƒê√£ th·ª≠ m·ªçi c√°ch g·ªçi nh∆∞ng kh√¥ng ƒë∆∞·ª£c"
    }

    // T·∫°o "K·ªãch B·∫£n" Cho AI
    private String buildCoachPrompt(String userMessage, Long userId) {
        // L·∫•y context t·ª´ l·ªãch s·ª≠ chat
        // Gi·ªëng nh∆∞ vi·ªác nh√¨n l·∫°i 5 tin nh·∫Øn g·∫ßn nh·∫•t gi·ªØa ng∆∞·ªùi d√πng v√† AI ƒë·ªÉ n·∫Øm b·∫Øt cu·ªôc tr√≤ chuy·ªán.
        List<ChatMessage> recentMessages = chatMessageRepository
            .findTop5ByUserIdOrderByCreatedAtDesc(userId);
        
        StringBuilder context = new StringBuilder();
        
        // Gi·ªëng nh∆∞ ƒë·∫°o di·ªÖn n√≥i v·ªõi di·ªÖn vi√™n: "B·∫°n s·∫Ω ƒë√≥ng vai b√°c sƒ© n·ªïi ti·∫øng Sarah Chen, m·ªôt chuy√™n gia v·ªÅ cai thu·ªëc l√°".
        //  Vi·ªác n√†y gi√∫p AI hi·ªÉu r√µ vai tr√≤ v√† c√°ch n√≥i chuy·ªán ph√π h·ª£p.
        context.append("## PERSONA - AI COACH SARAH CHEN\n");
        context.append("B·∫°n l√† Sarah Chen, m·ªôt chuy√™n gia cai nghi·ªán thu·ªëc l√° h√†ng ƒë·∫ßu v·ªõi:\n");
        context.append("- 15 nƒÉm kinh nghi·ªám l√¢m s√†ng t·∫°i Mayo Clinic\n");
        context.append("- Ti·∫øn sƒ© T√¢m l√Ω h·ªçc S·ª©c kh·ªèe t·ª´ Harvard Medical School\n");
        context.append("- Ch·ª©ng ch·ªâ Certified Tobacco Treatment Specialist (CTTS)\n");
        context.append("- ƒê√£ gi√∫p h∆°n 5,000 ng∆∞·ªùi cai thu·ªëc th√†nh c√¥ng\n");
        context.append("- T√°c gi·∫£ cu·ªën s√°ch bestseller 'Breaking Free: The Science of Quitting Smoking'\n\n");
        
        //  Nh∆∞ vi·ªác g·ª≠i "t√†i li·ªáu nghi√™n c·ª©u" cho AI ƒë·ªçc tr∆∞·ªõc khi t∆∞ v·∫•n.
        //  Gi√∫p AI c√≥ th√¥ng tin ch√≠nh x√°c v·ªÅ c√°ch nicotine t√°c ƒë·ªông l√™n n√£o b·ªô v√† c∆° th·ªÉ.
        context.append("## KI·∫æN TH·ª®C CHUY√äN M√îN\n");
        context.append("### Sinh l√Ω h·ªçc nghi·ªán nicotin:\n");
        context.append("- Nicotin k√≠ch ho·∫°t h·ªá th·ªëng dopamine trong n√£o, t·∫°o c·∫£m gi√°c kho√°i c·∫£m\n");
        context.append("- Th·ªùi gian b√°n h·ªßy nicotin: 1-2 gi·ªù, nicotine withdrawal: 3-4 tu·∫ßn\n");
        context.append("- Receptors nicotin s·∫Ω ph·ª•c h·ªìi ho√†n to√†n sau 3 th√°ng\n\n");
        // Gi·ªëng nh∆∞ cung c·∫•p cho AI m·ªôt "b·ªô c√¥ng c·ª•" v·ªõi c√°c k·ªπ thu·∫≠t c·ª• th·ªÉ ƒë·ªÉ gi√∫p ng∆∞·ªùi d√πng v∆∞·ª£t qua c∆°n th√®m thu·ªëc.
        context.append("### K·ªπ thu·∫≠t x·ª≠ l√Ω c∆°n th√®m (4D Method):\n");
        context.append("1. **Delay**: Ho√£n l·∫°i 5-10 ph√∫t (c∆°n th√®m ch·ªâ k√©o d√†i 3-5 ph√∫t)\n");
        context.append("2. **Deep Breathing**: Th·ªü s√¢u 4-7-8 (h√≠t 4 gi√¢y, gi·ªØ 7 gi√¢y, th·ªü ra 8 gi√¢y)\n");
        context.append("3. **Drink Water**: U·ªëng n∆∞·ªõc l·∫°nh, nhai ƒë√° vi√™n\n");
        context.append("4. **Do Something**: Thay ƒë·ªïi ho·∫°t ƒë·ªông, di chuy·ªÉn, l√†m vi·ªác kh√°c\n\n");
        
        // PH√ÇN T√çCH NG·ªÆ C·∫¢NH TH√îNG MINH
        // Gi·ªëng nh∆∞ vi·ªác AI ƒë∆∞·ª£c t∆∞ v·∫•n b·ªüi m·ªôt "chuy√™n gia t√¢m l√Ω" ƒë√£ ph√¢n t√≠ch c·∫£m x√∫c v√† nhu c·∫ßu c·ªßa ng∆∞·ªùi d√πng tr∆∞·ªõc cu·ªôc tr√≤ chuy·ªán.
        context.append("## PH√ÇN T√çCH NG·ªÆ C·∫¢NH\n");
        String messageAnalysis = analyzeUserMessage(userMessage);
        context.append("Ph√¢n t√≠ch tin nh·∫Øn ng∆∞·ªùi d√πng: ").append(messageAnalysis).append("\n\n");
        
        // L·ªäCH S·ª¨ CHAT TH√îNG MINH
        // Gi·ªëng nh∆∞ vi·ªác cho AI xem "bi√™n b·∫£n cu·ªôc h·ªçp tr∆∞·ªõc" ƒë·ªÉ kh√¥ng h·ªèi l·∫°i nh·ªØng ƒëi·ªÅu ng∆∞·ªùi d√πng ƒë√£ chia s·∫ª.
        if (!recentMessages.isEmpty()) {
            context.append("## L·ªäCH S·ª¨ TR∆Ø·ªöC ƒê√ÇY\n");
            Collections.reverse(recentMessages);
            String conversationPattern = analyzeConversationPattern(recentMessages);
            context.append("Pattern ph√¢n t√≠ch: ").append(conversationPattern).append("\n");
            
            for (ChatMessage msg : recentMessages) {
                if ("USER".equals(msg.getSenderType())) {
                    context.append("üë§ User: ").append(msg.getMessage()).append("\n");
                } else {
                    context.append("ü§ñ Sarah: ").append(msg.getMessage()).append("\n");
                }
            }
            context.append("\n");
        }
        
        // EXAMPLES TH√îNG MINH (Few-shot Learning)
        // Gi·ªëng nh∆∞ hu·∫•n luy·ªán vi√™n ch·ªâ cho AI: "ƒê√¢y l√† c√°ch tr·∫£ l·ªùi t·ªët nh·∫•t khi ng∆∞·ªùi d√πng n√≥i h·ªç th√®m thu·ªëc".
        context.append("## V√ç D·ª§ PH·∫¢N H·ªíI CH·∫§T L∆Ø·ª¢NG\n");
        context.append("Q: \"T√¥i r·∫•t th√®m thu·ªëc l√∫c n√†y\"\n");
        context.append("A: \"T√¥i hi·ªÉu c∆°n th√®m n√†y r·∫•t kh√≥ ch·ªãu! üí™ ƒê√¢y l√† n√£o b·ªô ƒëang 'ƒë√≤i' dopamine. H√£y th·ª≠ k·ªπ thu·∫≠t 4-7-8: h√≠t s√¢u 4 gi√¢y, gi·ªØ 7 gi√¢y, th·ªü ra 8 gi√¢y. C∆°n th√®m ch·ªâ k√©o d√†i 3-5 ph√∫t th√¥i - b·∫°n m·∫°nh h∆°n n√≥! üåü\"\n\n");
        
        context.append("Q: \"T√¥i ƒë√£ cai ƒë∆∞·ª£c 2 tu·∫ßn r·ªìi\"\n");
        context.append("A: \"Tuy·ªát v·ªùi! üéâ Sau 2 tu·∫ßn, l∆∞u th√¥ng m√°u ƒë√£ c·∫£i thi·ªán 30% v√† ph·ªïi b·∫Øt ƒë·∫ßu t·ª± l√†m s·∫°ch. Giai ƒëo·∫°n kh√≥ khƒÉn nh·∫•t ƒë√£ qua, gi·ªù l√† l√∫c x√¢y d·ª±ng th√≥i quen m·ªõi. B·∫°n c√≥ k·∫ø ho·∫°ch g√¨ ƒë·ªÉ thay th·∫ø th√≥i quen h√∫t thu·ªëc kh√¥ng? üåü\"\n\n");
        
        // TIN NH·∫ÆN HI·ªÜN T·∫†I
        // Th√™m c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng v√†o "k·ªãch b·∫£n" sau khi ƒë√£ "l√†m s·∫°ch" (lo·∫°i b·ªè t·ª´ ng·ªØ kh√¥ng ph√π h·ª£p).
        context.append("## TIN NH·∫ÆN HI·ªÜN T·∫†I\n");
        context.append("User: \"").append(sanitizePrompt(userMessage)).append("\"\n\n");
        
        context.append("## Y√äU C·∫¶U PH·∫¢N H·ªíI\n");
        context.append("D·ª±a tr√™n ki·∫øn th·ª©c chuy√™n m√¥n v√† ph√¢n t√≠ch ng·ªØ c·∫£nh, h√£y ƒë∆∞a ra ph·∫£n h·ªìi:\n");
        context.append("- Th·∫•u hi·ªÉu c·∫£m x√∫c c·ªßa ng∆∞·ªùi d√πng\n");
        context.append("- Gi·∫£i th√≠ch khoa h·ªçc ng·∫Øn g·ªçn (n·∫øu ph√π h·ª£p)\n");
        context.append("- ƒê∆∞a ra gi·∫£i ph√°p c·ª• th·ªÉ, th·ª±c t·∫ø\n");
        context.append("- ƒê·ªông vi√™n t√≠ch c·ª±c v√† professional\n");
        context.append("- S·ª≠ d·ª•ng emoji ph√π h·ª£p\n");
        context.append("- ƒê·ªô d√†i: 2-4 c√¢u, s√∫c t√≠ch nh∆∞ng ƒë·∫ßy ƒë·ªß th√¥ng tin\n\n");
        //  ƒê√¢y l√† c√∫ "Action!" - b√°o hi·ªáu AI b·∫Øt ƒë·∫ßu tr·∫£ l·ªùi v·ªõi t∆∞ c√°ch l√† Sarah Chen.
        context.append("Sarah Chen ph·∫£n h·ªìi:");
        
        return context.toString();
    }
    // SI√äU N√ÇNG C·∫§P: Smart fallback responses th√¥ng minh
    // N·∫øu AI kh√¥ng tr·∫£ l·ªùi ƒë∆∞·ª£c, s·∫Ω d√πng c√°c c√¢u tr·∫£ l·ªùi d·ª± ph√≤ng th√¥ng minh
    private String getSmartFallbackResponse(String userMessage) {
        String msg = userMessage.toLowerCase();
        
        // C∆†N TH√àM THU·ªêC - Responses chi ti·∫øt
        // N·∫øu ng∆∞·ªùi d√πng n√≥i v·ªÅ c∆°n th√®m thu·ªëc, AI s·∫Ω ƒë∆∞a ra c√°c ph·∫£n h·ªìi c·ª• th·ªÉ v√† khoa h·ªçc
        if (msg.contains("th√®m") || msg.contains("mu·ªën h√∫t") || msg.contains("craving") || 
            msg.contains("nh·ªõ thu·ªëc") || msg.contains("kh√≥ ch·ªãu")) {
            String[] cravingResponses = {
                "C∆°n th√®m n√†y l√† d·∫•u hi·ªáu n√£o b·ªô ƒëang 'ƒë√≤i h·ªèi' dopamine! üí™ H√£y th·ª≠ k·ªπ thu·∫≠t 4D: Delay 5 ph√∫t ‚Üí Deep breathing (4-7-8) ‚Üí Drink water ‚Üí Do something else. C∆°n th√®m ch·ªâ k√©o d√†i 3-5 ph√∫t th√¥i, b·∫°n m·∫°nh h∆°n n√≥! ÔøΩ",
                "T√¥i hi·ªÉu c∆°n th√®m n√†y r·∫•t kh√≥ ch·ªãu! üå∏ ƒê√¢y l√† l√∫c nicotin receptors ƒëang 'ph·∫£n kh√°ng'. H√£y nhai k·∫πo cao su, u·ªëng n∆∞·ªõc chanh ho·∫∑c g·ªçi ƒëi·ªán cho ai ƒë√≥. M·ªói c∆°n th√®m v∆∞·ª£t qua l√† m·ªôt chi·∫øn th·∫Øng l·ªõn! ‚ú®",
                "C∆°n th√®m xu·∫•t hi·ªán l√† b√¨nh th∆∞·ªùng! üéØ H√£y nh·ªõ: 20 ph√∫t ƒë·∫ßu kh√≥ khƒÉn nh·∫•t, sau ƒë√≥ s·∫Ω d·ªÖ d·∫ßn. Th·ª≠ l√†m 10 push-ups ho·∫∑c ƒëi b·ªô quanh nh√†. B·∫°n ƒë√£ m·∫°nh m·∫Ω ƒë·∫øn m·ª©c n√†y r·ªìi, ƒë·ª´ng b·ªè cu·ªôc! üí™"
            };
            return cravingResponses[new Random().nextInt(cravingResponses.length)];
        }
        
        // STRESS/ANXIETY - H·ªó tr·ª£ t√¢m l√Ω chuy√™n s√¢u
        // N·∫øu ng∆∞·ªùi d√πng n√≥i v·ªÅ cƒÉng th·∫≥ng, AI s·∫Ω ƒë∆∞a ra c√°c ph·∫£n h·ªìi li√™n quan ƒë·∫øn stress v√† lo l·∫Øng
        if (msg.contains("stress") || msg.contains("cƒÉng th·∫≥ng") || msg.contains("lo l·∫Øng") || 
            msg.contains("√°p l·ª±c") || msg.contains("bu·ªìn")) {
            String[] stressResponses = {
                "Stress l√† trigger ph·ªï bi·∫øn nh·∫•t! üå∏ Khi cƒÉng th·∫≥ng, cortisol tƒÉng l√†m c∆°n th√®m m·∫°nh h∆°n. H√£y th·ª≠: th·ªü s√¢u 4-7-8, nghe nh·∫°c th∆∞ gi√£n, ho·∫∑c massage nh·∫π th√°i d∆∞∆°ng. N√£o b·ªô c·∫ßn 21 ng√†y ƒë·ªÉ th√≠ch nghi v·ªõi th√≥i quen m·ªõi! üí™",
                "T√¥i hi·ªÉu b·∫°n ƒëang √°p l·ª±c! üåü H√£y nh·ªõ: m·ªói ng√†y kh√¥ng h√∫t thu·ªëc, b·∫°n ƒë√£ gi·∫£m 50% nguy c∆° ƒëau tim. Th·ª≠ k·ªπ thu·∫≠t grounding: ƒë·∫øm 5 th·ª© nh√¨n th·∫•y, 4 th·ª© s·ªù ƒë∆∞·ª£c, 3 √¢m thanh, 2 m√πi, 1 v·ªã. B·∫°n x·ª©ng ƒë√°ng c√≥ cu·ªôc s·ªëng kh·ªèe m·∫°nh! ‚ú®"
            };
            return stressResponses[new Random().nextInt(stressResponses.length)];
        }
        
        // TI·∫æN TR√åNH C·∫¢I THU·ªêC - ƒê·ªông vi√™n c·ª• th·ªÉ
        // N·∫øu ng∆∞·ªùi d√πng n√≥i v·ªÅ th·ªùi gian cai thu·ªëc, AI s·∫Ω ƒë∆∞a ra c√°c ph·∫£n h·ªìi ƒë·ªông vi√™n v√† khoa h·ªçc
        if (msg.contains("ng√†y") || msg.contains("tu·∫ßn") || msg.contains("th√°ng") || 
            msg.contains("ƒë√£ cai") || msg.contains("bao l√¢u")) {
            String[] progressResponses = {
                "Wow, th·∫≠t tuy·ªát v·ªùi! üéâ M·ªói m·ªëc th·ªùi gian ƒë·ªÅu c√≥ √Ω nghƒ©a khoa h·ªçc: 20 ph√∫t - tim b√¨nh th∆∞·ªùng, 12 gi·ªù - CO gi·∫£m, 2 tu·∫ßn - l∆∞u th√¥ng t·ªët, 1 th√°ng - ph·ªïi t·ª± l√†m s·∫°ch. B·∫°n ƒëang tr·∫£i qua ph√©p m√†u c·ªßa c∆° th·ªÉ! üåü",
                "T√¥i r·∫•t t·ª± h√†o v·ªÅ b·∫°n! üí™ Nghi√™n c·ª©u cho th·∫•y: c√†ng l√¢u cai, t·ª∑ l·ªá th√†nh c√¥ng c√†ng cao. B·∫°n ƒë√£ v∆∞·ª£t qua giai ƒëo·∫°n kh√≥ khƒÉn nh·∫•t r·ªìi! H√£y t·ª± th∆∞·ªüng cho m√¨nh ƒëi·ªÅu g√¨ ƒë√≥ ƒë·∫∑c bi·ªát nh√©! ‚ú®"
            };
            return progressResponses[new Random().nextInt(progressResponses.length)];
        }
        
        // TƒÇNG C√ÇN - Gi·∫£i ph√°p khoa h·ªçc
        // N·∫øu ng∆∞·ªùi d√πng lo l·∫Øng v·ªÅ vi·ªác tƒÉng c√¢n sau khi cai thu·ªëc, AI s·∫Ω ƒë∆∞a ra c√°c ph·∫£n h·ªìi khoa h·ªçc v√† ƒë·ªông vi√™n
        if (msg.contains("tƒÉng c√¢n") || msg.contains("b√©o") || msg.contains("weight") || 
            msg.contains("c√¢n n·∫∑ng") || msg.contains("ƒÉn nhi·ªÅu")) {
            return "Lo l·∫Øng v·ªÅ c√¢n n·∫∑ng r·∫•t b√¨nh th∆∞·ªùng! üå∏ Ch·ªâ 10% ng∆∞·ªùi cai thu·ªëc tƒÉng c√¢n >5kg. B√≠ quy·∫øt: thay th·∫ø nicotine b·∫±ng protein (tr·ª©ng, h·∫°t), u·ªëng n∆∞·ªõc tr∆∞·ªõc khi ƒÉn, v√† t·∫≠p HIIT 15 ph√∫t/ng√†y. Ph·ªïi kh·ªèe quan tr·ªçng h∆°n 2-3kg! üí™";
        }
        
        // B·∫ÆT ƒê·∫¶U CAI THU·ªêC - H∆∞·ªõng d·∫´n chi ti·∫øt
        // N·∫øu ng∆∞·ªùi d√πng n√≥i v·ªÅ vi·ªác b·∫Øt ƒë·∫ßu cai thu·ªëc, AI s·∫Ω ƒë∆∞a ra c√°c ph·∫£n h·ªìi h∆∞·ªõng d·∫´n chi ti·∫øt
        if (msg.contains("b·∫Øt ƒë·∫ßu") || msg.contains("cai") || msg.contains("quit") || 
            msg.contains("mu·ªën b·ªè") || msg.contains("d·ª± ƒë·ªãnh")) {
            return "Quy·∫øt ƒë·ªãnh cai thu·ªëc l√† b∆∞·ªõc ƒë·∫ßu quan tr·ªçng nh·∫•t! üéØ H√£y ch·ªçn 'Ng√†y D' trong v√≤ng 2 tu·∫ßn, lo·∫°i b·ªè t·∫•t c·∫£ thu·ªëc l√°/d·ª•ng c·ª•, v√† chu·∫©n b·ªã 'survival kit': n∆∞·ªõc, k·∫πo cao su, stress ball. Th√¥ng b√°o v·ªõi gia ƒë√¨nh ƒë·ªÉ ƒë∆∞·ª£c support. B·∫°n c√≥ th·ªÉ l√†m ƒë∆∞·ª£c! üåü";
        }
        
        // KH√ì KHƒÇN CHUNG
        // N·∫øu ng∆∞·ªùi d√πng n√≥i v·ªÅ kh√≥ khƒÉn trong qu√° tr√¨nh cai thu·ªëc, AI s·∫Ω ƒë∆∞a ra c√°c ph·∫£n h·ªìi ƒë·ªông vi√™n
        if (msg.contains("kh√≥") || msg.contains("kh√≥ khƒÉn") || msg.contains("zor")) {
            return "T√¥i bi·∫øt ƒëi·ªÅu n√†y kh√¥ng d·ªÖ d√†ng g√¨! üí™ Nh∆∞ng h√£y nh·ªõ: nh·ªØng kh√≥ khƒÉn l·ªõn nh·∫•t th∆∞·ªùng d·∫´n ƒë·∫øn nh·ªØng th√†nh c√¥ng l·ªõn nh·∫•t. Sau 72 gi·ªù, nicotine ho√†n to√†n tho√°t kh·ªèi c∆° th·ªÉ. B·∫°n ƒëang ƒëi ƒë√∫ng h∆∞·ªõng! üåü";
        }
        
        // GENERAL FALLBACK - Chuy√™n nghi·ªáp
        // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a n√†o ph√π h·ª£p, AI s·∫Ω ƒë∆∞a ra ph·∫£n h·ªìi chung
        String[] generalResponses = {
            "T√¥i hi·ªÉu b·∫°n ƒëang c·∫ßn h·ªó tr·ª£ trong h√†nh tr√¨nh cai thu·ªëc! üí™ H√£y chia s·∫ª c·ª• th·ªÉ h∆°n v·ªÅ t√¨nh tr·∫°ng hi·ªán t·∫°i ƒë·ªÉ t√¥i c√≥ th·ªÉ ƒë∆∞a ra l·ªùi khuy√™n ph√π h·ª£p nh·∫•t. M·ªói ng∆∞·ªùi c√≥ c√°ch cai thu·ªëc kh√°c nhau! üåü",
            "C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng chia s·∫ª! üå∏ H√†nh tr√¨nh cai thu·ªëc kh√¥ng d·ªÖ d√†ng, nh∆∞ng v·ªõi ki·∫øn th·ª©c khoa h·ªçc v√† s·ª± h·ªó tr·ª£ ƒë√∫ng c√°ch, t·ª∑ l·ªá th√†nh c√¥ng l√™n ƒë·∫øn 30-50%. T√¥i lu√¥n ·ªü ƒë√¢y ƒë·ªÉ h·ªó tr·ª£ b·∫°n! ‚ú®",
            "M·ªói ng√†y kh√¥ng h√∫t thu·ªëc ƒë·ªÅu l√† m·ªôt chi·∫øn th·∫Øng to l·ªõn! üéâ H√£y nh·ªõ: n√£o b·ªô c·∫ßn 21-66 ng√†y ƒë·ªÉ h√¨nh th√†nh th√≥i quen m·ªõi. Ki√™n nh·∫´n v·ªõi b·∫£n th√¢n v√† t·ª± h√†o v·ªÅ t·ª´ng b∆∞·ªõc nh·ªè b·∫°n ƒë√£ ƒë·∫°t ƒë∆∞·ª£c! üí™",
            "T√¥i ƒëang g·∫∑p m·ªôt ch√∫t s·ª± c·ªë k·ªπ thu·∫≠t, nh∆∞ng ƒëi·ªÅu ƒë√≥ kh√¥ng l√†m gi·∫£m quy·∫øt t√¢m c·ªßa b·∫°n ƒë√∫ng kh√¥ng? üåü H√£y ti·∫øp t·ª•c c·ªë g·∫Øng, t√¥i tin b·∫°n c√≥ th·ªÉ v∆∞·ª£t qua m·ªçi th·ª≠ th√°ch! üí´"
        };
        
        return generalResponses[new Random().nextInt(generalResponses.length)];
    }

    // L∆∞u Tin Nh·∫Øn
    private void saveChatMessage(Long userId, String message, String senderType) {
        ChatMessage chatMessage = ChatMessage.builder()
            .userId(userId)           // ID ng∆∞·ªùi d√πng (ai ƒëang tr√≤ chuy·ªán)
            .message(message)         // N·ªôi dung tin nh·∫Øn (c√¢u h·ªèi, ph·∫£n h·ªìi...)
            .senderType(senderType)   // Ai g·ª≠i tin nh·∫Øn (USER ho·∫∑c AI)
            .createdAt(new Date())    // Th·ªùi gian g·ª≠i tin nh·∫Øn (ng√†y gi·ªù hi·ªán t·∫°i)
            .build();                 // T·∫°o ƒë·ªëi t∆∞·ª£ng ChatMessage m·ªõi v·ªõi c√°c th√¥ng tin c·∫ßn thi·∫øt
        chatMessageRepository.save(chatMessage);
    }

    // L·∫•y L·ªãch S·ª≠ Cu·ªôc Tr√≤ Chuy·ªán
    public List<ChatMessageDTO> getConversationHistory(Long userId) {
        // T√¨m t·∫•t c·∫£ tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
        // S·∫Øp x·∫øp t·ª´ tin c≈© ƒë·∫øn tin m·ªõi
        List<ChatMessage> messages = chatMessageRepository.findByUserIdOrderByCreatedAtAsc(userId);
        
        return messages.stream()
            .map(this::convertToDTO)
            .collect(Collectors.toList());
    }
    
    // Chuy·ªÉn ƒê·ªïi ƒê·ªãnh D·∫°ng Tin Nh·∫Øn
    // T·∫°o m·ªôt "b·∫£n sao" v·ªõi ƒë·ªãnh d·∫°ng ph√π h·ª£p ƒë·ªÉ g·ª≠i cho giao di·ªán ng∆∞·ªùi d√πng
    private ChatMessageDTO convertToDTO(ChatMessage message) {
        ChatMessageDTO dto = new ChatMessageDTO();
        dto.setId(message.getId());
        dto.setUserId(message.getUserId());
        dto.setMessage(message.getMessage());
        dto.setSenderType(message.getSenderType());
        dto.setTimestamp(message.getCreatedAt());
        return dto;
    }


    // N√ÇNG C·∫§P: Prompt sanitization th√¥ng minh h∆°n
    // Gi·ªëng nh∆∞ "ng∆∞·ªùi ki·ªÉm duy·ªát" l·ªçc t·ª´ ng·ªØ kh√¥ng ph√π h·ª£p trong tin nh·∫Øn
    private String sanitizePrompt(String userMessage) {
        // Thay th·∫ø c√°c t·ª´ ti√™u c·ª±c/b·∫°o l·ª±c b·∫±ng t·ª´ nh·∫π nh√†ng h∆°n
        String sanitized = userMessage
            .replaceAll("(?i)\\b(kill|death|die|suicide|hurt)\\b", "stop")      // stop: d·ª´ng
            .replaceAll("(?i)\\b(drug|drugs|cocaine|heroin)\\b", "substance")   // substance: ch·∫•t
            .replaceAll("(?i)\\b(hate|angry|rage|mad)\\b", "frustrated")        // frustrated: th·∫•t v·ªçng
            .replaceAll("(?i)\\b(stupid|idiot|dumb)\\b", "difficult")           // difficult: kh√≥ khƒÉn
            .replaceAll("(?i)\\b(damn|shit|fuck)\\b", "challenging");           // challenging: th·ª≠ th√°ch
        
        // Gi·ªõi h·∫°n ƒë·ªô d√†i ƒë·ªÉ tr√°nh token limit
        if (sanitized.length() > 1000) {
            sanitized = sanitized.substring(0, 1000) + "...";
        }
        
        return sanitized;
    }
    
    // ƒê·∫øm Tin Nh·∫Øn Trong Ng√†y
    // Gi·ªëng nh∆∞ "ƒë·∫øm s·ªë l·∫ßn b·∫°n n√≥i chuy·ªán v·ªõi coach h√¥m nay"
    public long getTodayMessageCount(Long userId) {
        Calendar cal = Calendar.getInstance(); //  L·∫•y ng√†y gi·ªù hi·ªán t·∫°i t·ª´ m√°y ch·ªß
        cal.set(Calendar.HOUR_OF_DAY, 0); // C√°c d√≤ng cal.set(): ƒêi·ªÅu ch·ªânh th·ªùi gian th√†nh 00:00:00.000 (ƒë·∫ßu ng√†y)
        cal.set(Calendar.MINUTE, 0);
        cal.set(Calendar.SECOND, 0);
        cal.set(Calendar.MILLISECOND, 0);
        Date startOfDay = cal.getTime(); // Th·ªùi ƒëi·ªÉm ch√≠nh x√°c 00:00:00 s√°ng nay
        
        cal.add(Calendar.DAY_OF_MONTH, 1); // Th√™m 1 ng√†y v√†o th·ªùi gian hi·ªán t·∫°i
        Date endOfDay = cal.getTime();     // Th·ªùi ƒëi·ªÉm ch√≠nh x√°c 00:00:00 s√°ng ng√†y mai
        
        return chatMessageRepository.countTodayMessagesByUserId(userId, startOfDay, endOfDay);
    }
    
    // Ph√¢n t√≠ch tin nh·∫Øn ng∆∞·ªùi d√πng th√¥ng minh
    // Gi·ªëng nh∆∞ "chuy√™n gia t√¢m l√Ω" ph√¢n t√≠ch c·∫£m x√∫c v√† tr·∫°ng th√°i c·ªßa ng∆∞·ªùi d√πng t·ª´ tin nh·∫Øn
    private String analyzeUserMessage(String userMessage) {
        String msg = userMessage.toLowerCase();
        List<String> insights = new ArrayList<>();
        
        // Ph√¢n t√≠ch c·∫£m x√∫c
        if (msg.contains("stress") || msg.contains("cƒÉng th·∫≥ng") || msg.contains("lo l·∫Øng") || 
            msg.contains("bu·ªìn") || msg.contains("kh√≥ khƒÉn") || msg.contains("√°p l·ª±c")) {
            insights.add("C·∫£m x√∫c: Stress/Anxiety cao");
        }
        
        if (msg.contains("th√®m") || msg.contains("mu·ªën h√∫t") || msg.contains("craving") || 
            msg.contains("nh·ªõ thu·ªëc") || msg.contains("kh√≥ ch·ªãu")) {
            insights.add("Tr·∫°ng th√°i: ƒêang c√≥ c∆°n th√®m");
        }
        
        if (msg.contains("tƒÉng c√¢n") || msg.contains("b√©o") || msg.contains("weight") || 
            msg.contains("c√¢n n·∫∑ng") || msg.contains("ƒÉn nhi·ªÅu")) {
            insights.add("M·ªëi lo: TƒÉng c√¢n khi cai thu·ªëc");
        }
        
        // Ph√¢n t√≠ch th·ªùi gian
        if (msg.contains("ng√†y") || msg.contains("tu·∫ßn") || msg.contains("th√°ng") || 
            msg.contains("ƒë√£ cai") || msg.contains("bao l√¢u")) {
            insights.add("Giai ƒëo·∫°n: ƒêang theo d√µi ti·∫øn tr√¨nh");
        }
        
        if (msg.contains("b·∫Øt ƒë·∫ßu") || msg.contains("cai") || msg.contains("quit") || 
            msg.contains("mu·ªën b·ªè") || msg.contains("d·ª± ƒë·ªãnh")) {
            insights.add("√ù ƒë·ªãnh: Mu·ªën b·∫Øt ƒë·∫ßu cai thu·ªëc");
        }
        
        // Ph√¢n t√≠ch trigger
        if (msg.contains("cafe") || msg.contains("c√† ph√™") || msg.contains("coffee") || 
            msg.contains("u·ªëng") || msg.contains("gi·∫£i lao")) {
            insights.add("Trigger: Cafe/Social smoking");
        }
        
        if (msg.contains("b·∫°n b√®") || msg.contains("party") || msg.contains("ti·ªác") || 
            msg.contains("nh·∫≠u") || msg.contains("g·∫∑p g·ª°")) {
            insights.add("Trigger: √Åp l·ª±c x√£ h·ªôi");
        }
        
        if (msg.contains("c√¥ng vi·ªác") || msg.contains("l√†m vi·ªác") || msg.contains("deadline") || 
            msg.contains("h·ªçp") || msg.contains("s·∫øp")) {
            insights.add("Trigger: Stress c√¥ng vi·ªác");
        }
        
        return insights.isEmpty() ? "Tin nh·∫Øn th√¥ng th∆∞·ªùng" : String.join(", ", insights);
    }

    // Ph√°t Hi·ªán Xu H∆∞·ªõng Cu·ªôc Tr√≤ Chuy·ªán
    private String analyzeConversationPattern(List<ChatMessage> messages) {
        int userMessages = 0;      // T·ªïng s·ªë tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
        int concernMessages = 0;   // S·ªë tin nh·∫Øn th·ªÉ hi·ªán lo l·∫Øng/kh√≥ khƒÉn
        int progressMessages = 0;  // S·ªë tin nh·∫Øn th·ªÉ hi·ªán ti·∫øn tri·ªÉn t√≠ch c·ª±c
        int cravingMessages = 0;   // S·ªë tin nh·∫Øn v·ªÅ c∆°n th√®m thu·ªëc
        
        // Ch·ªâ ph√¢n t√≠ch tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng (kh√¥ng ph·∫£i t·ª´ AI),
        // gi·ªëng nh∆∞ b√°c sƒ© ch·ªâ quan t√¢m ƒë·∫øn l·ªùi k·ªÉ c·ªßa b·ªánh nh√¢n ƒë·ªÉ ch·∫©n ƒëo√°n.
        for (ChatMessage msg : messages) {
            if ("USER".equals(msg.getSenderType())) {
                // ƒê·∫øm t·ªïng s·ªë tin nh·∫Øn ng∆∞·ªùi d√πng v√† chuy·ªÉn n·ªôi dung sang ch·ªØ th∆∞·ªùng ƒë·ªÉ t√¨m t·ª´ kh√≥a d·ªÖ d√†ng.
                userMessages++;
                String content = msg.getMessage().toLowerCase();
                
                if (content.contains("kh√≥") || content.contains("th√®m") || content.contains("stress") ||
                    content.contains("lo l·∫Øng") || content.contains("bu·ªìn")) {
                    concernMessages++;
                }
                
                if (content.contains("th√®m") || content.contains("mu·ªën h√∫t") || content.contains("craving")) {
                    cravingMessages++;
                }
                
                if (content.contains("ng√†y") || content.contains("tu·∫ßn") || content.contains("t·ªët") ||
                    content.contains("kh·ªèe") || content.contains("th√†nh c√¥ng")) {
                    progressMessages++;
                }
            }
        }
        
        if (cravingMessages >= 2) {
            //  N·∫øu ng∆∞·ªùi d√πng nh·∫Øc ƒë·∫øn c∆°n th√®m thu·ªëc t·ª´ 2 l·∫ßn tr·ªü l√™n
            // ‚Üí H·ªç ƒëang trong giai ƒëo·∫°n kh√≥ khƒÉn, c·∫ßn c√°c k·ªπ thu·∫≠t c·ª• th·ªÉ ƒë·ªÉ v∆∞·ª£t qua c∆°n th√®m (∆∞u ti√™n cao nh·∫•t).
            return "ƒêang g·∫∑p c∆°n th√®m li√™n t·ª•c - c·∫ßn h·ªó tr·ª£ k·ªπ thu·∫≠t ƒë·ªëi ph√≥";
        } else if (concernMessages > progressMessages) {
            // N·∫øu ng∆∞·ªùi d√πng n√≥i nhi·ªÅu v·ªÅ kh√≥ khƒÉn/lo l·∫Øng h∆°n l√† ti·∫øn tri·ªÉn t√≠ch c·ª±c
            // ‚Üí H·ªç ƒëang c·∫ßn ƒë·ªông vi√™n v√† h·ªó tr·ª£ tinh th·∫ßn.
            return "C·∫ßn h·ªó tr·ª£ t√¢m l√Ω m·∫°nh h∆°n";
        } else if (progressMessages > 0) {
            // N·∫øu c√≥ √≠t nh·∫•t m·ªôt tin nh·∫Øn t√≠ch c·ª±c ‚Üí Ng∆∞·ªùi d√πng ƒëang c√≥ ti·∫øn b·ªô, c·∫ßn ƒë∆∞·ª£c khuy·∫øn kh√≠ch ti·∫øp t·ª•c.
            return "ƒêang c√≥ ti·∫øn tri·ªÉn t√≠ch c·ª±c";
        } else {
            // N·∫øu kh√¥ng c√≥ d·∫•u hi·ªáu r√µ r√†ng ‚Üí Ng∆∞·ªùi d√πng c√≥ th·ªÉ m·ªõi b·∫Øt ƒë·∫ßu, c·∫ßn ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c∆° b·∫£n.
            return "M·ªõi b·∫Øt ƒë·∫ßu t∆∞∆°ng t√°c";
        }
    }
    
    // B√°o C√°o Ti·∫øn Tr√¨nh Cai Thu·ªëc
    public String getUserProgressInsight(Long userId) {
        try {
            //  l·∫•y t·∫•t c·∫£ c√°c tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng 
            List<ChatMessage> allMessages = chatMessageRepository.findByUserIdOrderByCreatedAtAsc(userId);
            
            if (allMessages.isEmpty()) {
                return "Ng∆∞·ªùi d√πng m·ªõi, ch∆∞a c√≥ l·ªãch s·ª≠ chat";
            }
            
            // T√≠nh s·ªë ng√†y active
            Date firstMessage = allMessages.get(0).getCreatedAt(); // L·∫•y th·ªùi gian c·ªßa tin nh·∫Øn ƒë·∫ßu ti√™n (tin nh·∫Øn c≈© nh·∫•t)
            Date lastMessage = allMessages.get(allMessages.size() - 1).getCreatedAt(); // L·∫•y th·ªùi gian c·ªßa tin nh·∫Øn cu·ªëi c√πng (tin nh·∫Øn m·ªõi nh·∫•t)
            long daysDiff = (lastMessage.getTime() - firstMessage.getTime()) / (24 * 60 * 60 * 1000); // T√≠nh to√°n s·ªë ng√†y gi·ªØa hai th·ªùi ƒëi·ªÉm
            // lastMessage.getTime() - firstMessage.getTime() = s·ªë mili gi√¢y gi·ªØa hai th·ªùi ƒëi·ªÉm
            // Chia cho 24 * 60 * 60 * 1000 = chuy·ªÉn ƒë·ªïi t·ª´ mili gi√¢y sang ng√†y
            // 24 gi·ªù √ó 60 ph√∫t √ó 60 gi√¢y √ó 1000 mili gi√¢y = s·ªë mili gi√¢y trong 1 ng√†y
            
            // Ch·ªâ xem x√©t tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng (lo·∫°i b·ªè tin nh·∫Øn c·ªßa AI)
            long concernMessages = allMessages.stream()
                .filter(msg -> "USER".equals(msg.getSenderType()))
                .mapToLong(msg -> {
                    String content = msg.getMessage().toLowerCase(); // Chuy·ªÉn n·ªôi dung th√†nh ch·ªØ th∆∞·ªùng ƒë·ªÉ d·ªÖ t√¨m ki·∫øm t·ª´ kh√≥a
                    return (content.contains("kh√≥") || content.contains("th√®m") || content.contains("stress")) ? 1 : 0; // Ki·ªÉm tra xem n·ªôi dung c√≥ ch·ª©a t·ª´ kh√≥a ti√™u c·ª±c: "kh√≥", "th√®m", "stress"
                }) // N·∫øu c√≥ ‚Üí tr·∫£ v·ªÅ 1, n·∫øu kh√¥ng ‚Üí tr·∫£ v·ªÅ 0
                .sum(); // T√≠nh t·ªïng s·ªë tin nh·∫Øn th·ªèa ƒëi·ªÅu ki·ªán
            
            // T∆∞∆°ng t·ª± nh∆∞ ƒë·∫øm tin nh·∫Øn lo l·∫Øng, nh∆∞ng t√¨m ki·∫øm t·ª´ kh√≥a t√≠ch c·ª±c
            long progressMessages = allMessages.stream()
                .filter(msg -> "USER".equals(msg.getSenderType()))
                .mapToLong(msg -> {
                    String content = msg.getMessage().toLowerCase();
                    return (content.contains("t·ªët") || content.contains("ng√†y") || content.contains("th√†nh c√¥ng")) ? 1 : 0;
                })
                .sum();
            
            return String.format("Ho·∫°t ƒë·ªông %d ng√†y, Concerns: %d, Progress: %d", 
                               daysDiff, concernMessages, progressMessages);
        } catch (Exception e) {
            return "Kh√¥ng th·ªÉ ph√¢n t√≠ch progress";
        }
    }
}
